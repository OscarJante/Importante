<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- 1. Título de la página cambiado -->
  <title>Escaneo QR Visitas HDI Seguros</title>

  <!-- Librería para leer QR, como se describe en artículos de GeeksforGeeks -->
  <!-- https://www.geeksforgeeks.org/create-a-qr-code-scanner-or-reader-in-html-css-javascript/ -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
      background: #f4f6f8;
      color: #172b4d;
      text-align: center;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 0.2em;
	  margin-top: 0;
    }
    p {
      font-size: 1em;
      color: #5e6c84;
      line-height: 1.5;
	  text-align: center;
    }
    #reader {
      width: 300px;
      margin: 20px auto;
      border: 2px solid #dfe1e6;
      border-radius: 8px;
    }
    #taskInfo {
      background: #fff;
      border-radius: 10px;
      padding: 25px;
      border: 1px solid #dfe1e6;
      text-align: left;
      display: none;
      margin-top: 20px;
    }
    #taskInfo h2 {
      margin-top: 0;
      font-size: 1.5em;
      color: #172b4d;
    }
    #taskInfo img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 15px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    /* 4. Estilo del estado (resultado) hecho un poco más grande */
    .status {
      display: inline-block;
      background: #eee;
      padding: 5px 12px; /* Aumentado */
      border-radius: 6px;
      font-size: 1.1em; /* Aumentado */
      font-weight: bold;
      color: #333;
    }
	.nombre-propio {
      display: inline-block;
	  background: #eee;
      padding: 5px 12px; /* Aumentado */
      border-radius: 6px;
      font-size: 1.4em; /* Aumentado */
      font-weight: bold;
      color: #333;
	  text-align: center;
	}
	.status-green {
		background-color: #d4edda; /* Un verde pastel */
		color: #155724; /* Un verde oscuro para el texto */
	}
	.status-red {
		background-color: #f8d7da; /* Un rojo pastel */
		color: #721c24; /* Un rojo oscuro para el texto */
	}
    .label {
      font-weight: bold;
      color: #5e6c84;
      display: inline-block;
      width: 110px;
	  text-align: left;
    }
    button {
      padding: 10px 18px;
      font-size: 16px;
      background: #0052cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px; /* Margen aumentado para mejor separación */
      transition: background 0.2s;
    }
    button:hover {
      background: #0041a3;
    }
  </style>
</head>
<body>

  <h1>Visitas HDI Seguros</h1>

  <div id="reader"></div>

  <div id="taskInfo"></div>
  
  <button id="btnReiniciar" style="display:none;">Escanear Otro</button>

  <script>

		const urlParams = new URLSearchParams(window.location.search);

        // --- PASO 2: Obtener el valor del parámetro que nos interesa (en este caso, 'sede') ---
        const sedeSeleccionada = urlParams.get('sede');

	  
	  // Carga la información de una tarea desde tu función Netlify
    async function loadTask(taskId) {
      const info = document.getElementById("taskInfo");
      info.style.display = "block";
      info.innerHTML = "<p>Cargando tarea...</p>";

      try {
        // Asegúrate que el nombre de la función ('getTask') coincida con el de tu archivo en Netlify
        const res = await fetch('https://oscarjante.github.io/Importante/JSON.json');
        const data = await res.json();

        if (data.error) {
          info.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`;
          return;
        }

        // --- MODIFICADO: Se construye el HTML con el nuevo orden de campos ---
        // 4. El estado ahora es el primer dato después de la foto.
        info.innerHTML = `
          <h2>${data.name || "Tarea sin nombre"}</h2>
          <p><span class="nombre-propio ${obtenerClaseDeStatus(data.status).clase}">${obtenerClaseDeStatus(data.status).mensaje}</span></p>
		  
          <!-- Si existe foto_url, muestra la imagen. Si no, no muestra nada. -->
          ${data.foto_url ? `<img src="${data.foto_url}" alt="Fotografía de la persona">` : ''}
          
          <p><span class="label">Empresa:</span> ${sedeSeleccionada || "—"}</p>
          <p><span class="label">Tipo de visita:</span> ${data.tipo_visita || "—"}</p>
          <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
          <p><span class="label">Fecha inicio:</span> ${data.start_date ? new Date(data.start_date).toLocaleDateString() : "—"}</p>
          <p><span class="label">Fecha límite:</span> ${data.due_date ? new Date(data.due_date).toLocaleDateString() : "—"}</p>
        `;
      } catch (err) {
        console.error(err);
        info.innerHTML = '<p style="color: red;"><strong>Error:</strong> No se pudo conectar con el servidor.</p>';
      }
    }

    // Evento cuando se escanea un QR correctamente
    function onScanSuccess(decodedText) {
      // El QR podría contener una URL completa, extraemos solo el ID.
      let taskId = decodedText;
      try {
        const url = new URL(decodedText);
        // Si el QR tiene `app.clickup.com/t/xxxx`, extraemos el ID
        const pathParts = url.pathname.split('/');
        if(pathParts[1] === 't' && pathParts[2]) {
          taskId = pathParts[2];
        }
      } catch (e) {
        // No es una URL, asumimos que es el ID directamente.
      }
      
      console.log("Código leído, usando Task ID:", taskId);
      html5QrCode.stop(); // detiene la cámara
      document.getElementById("reader").style.display = "none";
      document.getElementById("btnReiniciar").style.display = "inline-block";
      loadTask(taskId); // usa el texto del QR como taskId
    }
    
    // Inicia el lector QR
    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => console.error("No se pudo iniciar el lector QR", err));


    // Permite volver a escanear
    document.getElementById("btnReiniciar").addEventListener("click", () => {
      document.getElementById("taskInfo").style.display = "none";
      document.getElementById("reader").style.display = "block";
      document.getElementById("btnReiniciar").style.display = "none";
      html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
          .catch(err => console.error("No se pudo reiniciar el lector QR", err));
    });
	
  function obtenerClaseDeStatus(status) {
  const statusLimpio = (status || '').toLowerCase();
  let clase = '';
  let mensaje = 'Estado desconocido';

  // Obtener la fecha y hora actual
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  const currentMinutes = hours * 60 + minutes; // Minutos desde medianoche

  const startMinutes = 6 * 60; // 06:00 = 360 minutos (común para todos)

  // Chequeo de fin de semana (0 = domingo, 6 = sábado)
  const isWeekend = now.getDay() === 0 || now.getDay() === 6;

  switch (statusLimpio) {
    case 'acceso vigente':
      if (isWeekend) {
        // Si es fin de semana, bloquear acceso incluso si es vigente
        clase = 'status-red';
        mensaje = 'Acceso no permitido en fines de semana';
      } else {
        // Definir endMinutes basado en si es viernes o no
        let endMinutes;
        if (now.getDay() === 5) { // Viernes
          endMinutes = 16 * 60 + 30; // 16:30 = 990 minutos
        } else {
          endMinutes = 19 * 60; // 19:00 = 1140 minutos (lunes a jueves)
        }

        // Chequear el rango horario
        if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
          clase = 'status-green';
          mensaje = 'Acceso Permitido';
        } else {
          clase = 'status-red';
          mensaje = 'Acceso no permitido fuera de horario laboral';
        }
      }
      break;
    case 'acceso restringido':
      clase = 'status-red';
      mensaje = 'Acceso no permitido';
    case 'acceso vip':
      clase = 'status-green';
      mensaje = 'Acceso permitido usuario VIP'
    break;
    // Default ya está manejado al inicio
  }

  return { clase, mensaje }; // Retorna un objeto con dos valores
  }
</script>
</body>
</html>



